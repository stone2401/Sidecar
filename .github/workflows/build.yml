name: æ„å»ºå’Œå‘å¸ƒ Sidecar

on:
  push:
    branches: [ main, master, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ===================================================================
  # æ­¥éª¤ 1: åœ¨å„ä¸ªå¹³å°ä¸Šæ„å»ºç‹¬ç«‹çš„äºŒè¿›åˆ¶æ–‡ä»¶
  # ===================================================================
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-24.04
            target: x86_64-unknown-linux-gnu
            name: linux-x64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            name: windows-x64
          - os: macos-latest
            target: x86_64-apple-darwin
            name: macos-intel
          - os: macos-latest
            target: aarch64-apple-darwin
            name: macos-arm64

    runs-on: ${{ matrix.os }}

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: å®‰è£… Rust å·¥å…·é“¾
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.target }}

    - name: å®‰è£…ç³»ç»Ÿä¾èµ– (Ubuntu)
      if: matrix.os == 'ubuntu-24.04'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libwebkit2gtk-4.1-dev \
          libjavascriptcoregtk-4.1-dev \
          libgtk-3-dev \
          libayatana-appindicator3-dev \
          librsvg2-dev \
          build-essential

    - name: Rust ç¼“å­˜
      uses: Swatinem/rust-cache@v2
      with:
        workspaces: './src-tauri -> target' # å‡è®¾ä½ çš„ Cargo.toml åœ¨ src-tauri ç›®å½•
        key: ${{ matrix.target }}

    - name: æ„å»ºè£¸äºŒè¿›åˆ¶æ–‡ä»¶
      # æ³¨æ„ï¼šè¿™é‡Œæ˜¯ä½ åšæŒä½¿ç”¨çš„ cargo buildï¼Œè€Œä¸æ˜¯ tauri build
      shell: bash
      run: |
        cd src-tauri
        cargo build --release --target ${{ matrix.target }} --verbose

    - name: å‡†å¤‡å¹¶é‡å‘½åäºŒè¿›åˆ¶æ–‡ä»¶
      shell: bash
      run: |
        # åˆ›å»ºä¸€ä¸ªä¸´æ—¶ç›®å½•å­˜æ”¾å‡†å¤‡å¥½çš„æ–‡ä»¶
        mkdir -p ./artifact

        # å®šä¹‰æºè·¯å¾„å’Œç›®æ ‡è·¯å¾„
        APP_NAME="sidecar" # ä½ ç¨‹åºåœ¨ Cargo.toml ä¸­å®šä¹‰çš„åå­—
        SOURCE_DIR="src-tauri/target/${{ matrix.target }}/release"
        TARGET_NAME="sidecar-${{ matrix.name }}"

        # æ ¹æ®æ“ä½œç³»ç»Ÿå¤åˆ¶å’Œé‡å‘½å
        if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
          cp "${SOURCE_DIR}/${APP_NAME}.exe" "./artifact/${TARGET_NAME}.exe"
          echo "âœ… Copied Windows binary to artifact/${TARGET_NAME}.exe"
        else
          cp "${SOURCE_DIR}/${APP_NAME}" "./artifact/${TARGET_NAME}"
          chmod +x "./artifact/${TARGET_NAME}"
          echo "âœ… Copied Unix binary to artifact/${TARGET_NAME}"
        fi
        
        ls -l ./artifact

    - name: ä¸Šä¼ å•ä¸ªå¹³å°çš„äºŒè¿›åˆ¶æ–‡ä»¶
      uses: actions/upload-artifact@v4
      with:
        name: sidecar-binary-${{ matrix.name }}
        path: ./artifact/
        retention-days: 7

  # ===================================================================
  # æ­¥éª¤ 2: åˆå¹¶æ‰€æœ‰äºŒè¿›åˆ¶æ–‡ä»¶å¹¶å‡†å¤‡å‘å¸ƒåŒ…
  # ===================================================================
  merge_and_release:
    needs: build
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç  (ç”¨äºè·å– README)
      uses: actions/checkout@v4

    - name: ä¸‹è½½æ‰€æœ‰æ„å»ºå¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶
      uses: actions/download-artifact@v4
      with:
        path: all-binaries/ # ä¸‹è½½åˆ°ç»Ÿä¸€çš„ç›®å½•
        pattern: sidecar-binary-*
        merge-multiple: true

    - name: æ•´ç†æ–‡ä»¶å¹¶åˆ›å»ºå‘å¸ƒåŒ…
      id: prep_release
      run: |
        # 1. åˆ›å»ºä¸€ä¸ªå¹²å‡€çš„å‘å¸ƒå‡†å¤‡åŒº
        mkdir -p release_assets
        
        # 2. å°†æ‰€æœ‰ä¸‹è½½çš„äºŒè¿›åˆ¶æ–‡ä»¶ç§»åŠ¨åˆ°å‡†å¤‡åŒº
        mv all-binaries/* release_assets/
        
        # 3. åœ¨å‡†å¤‡åŒºå†…ç”Ÿæˆæ ¡éªŒå’Œæ–‡ä»¶
        cd release_assets
        sha256sum sidecar-* > checksums.txt
        cd ..
        
        # 4. åˆ›å»ºä¸€ä¸ªåŒ…å«æ‰€æœ‰äºŒè¿›åˆ¶æ–‡ä»¶å’Œæ ¡éªŒå’Œçš„å‹ç¼©åŒ…
        VERSION="${GITHUB_REF_NAME:-latest}"
        # æ¸…ç†ç‰ˆæœ¬å·ä¸­çš„ 'v' (ä¾‹å¦‚ v1.2.3 -> 1.2.3)
        CLEAN_VERSION=$(echo "$VERSION" | sed 's/^v//')
        tar -czf "release_assets/sidecar-${CLEAN_VERSION}-all-platforms.tar.gz" -C release_assets .
        
        # 5. å°†ä½ çš„è¯´æ˜æ–‡æ¡£ä¹Ÿå¤åˆ¶åˆ°å‡†å¤‡åŒº
        # æ³¨æ„: ç¡®ä¿ä½ çš„ä»“åº“é‡Œæœ‰è¿™ä¸ª README-BINARY.md æ–‡ä»¶
        if [ -f "README-BINARY.md" ]; then
          cp README-BINARY.md release_assets/
        else
          echo "Warning: README-BINARY.md not found."
        fi
        
        echo "âœ… Release assets prepared:"
        ls -lR release_assets/

    - name: ä¸Šä¼ æœ€ç»ˆçš„å‘å¸ƒåŒ… (ä½œä¸ºæ„å»ºäº§ç‰©)
      uses: actions/upload-artifact@v4
      with:
        name: sidecar-release-package
        path: release_assets/
        retention-days: 30

    - name: åˆ›å»º GitHub Release (ä»…åœ¨æ‰“æ ‡ç­¾æ—¶è§¦å‘)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        # å…³é”®æ”¹åŠ¨: åªä¸Šä¼ å¹²å‡€çš„å‘å¸ƒå‡†å¤‡åŒºé‡Œçš„æ‰€æœ‰æ–‡ä»¶
        files: release_assets/*
        body: |
          ## ğŸ‰ Sidecar ${{ github.ref_name }} Release
          
          This release contains the bare-metal binaries for Sidecar. 
          Download the appropriate binary for your system, or the `.tar.gz` archive containing all platforms.
          
          ### âœ… Verification
          
          Please verify the integrity of the downloaded files using the `checksums.txt`:
          ```bash
          sha256sum -c checksums.txt
          ```

          ### ğŸš€ Quick Start
          
          **Linux / macOS:**
          ```bash
          chmod +x ./sidecar-linux-x64
          ./sidecar-linux-x64 --url https://example.com
          ```
          
          **Windows (CMD/PowerShell):**
          ```cmd
          sidecar-windows-x64.exe --url https://example.com
          ```
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

