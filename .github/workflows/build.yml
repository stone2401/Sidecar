name: 构建和发布 Sidecar

on:
  push:
    branches: [ main, master, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ===================================================================
  # 步骤 1: 构建独立的二进制文件 (此部分无变化)
  # ===================================================================
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-24.04
            target: x86_64-unknown-linux-gnu
            name: linux-x64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            name: windows-x64
          - os: macos-15
            target: x86_64-apple-darwin
            name: macos-intel
          - os: macos-15
            target: aarch64-apple-darwin
            name: macos-arm64

    runs-on: ${{ matrix.os }}
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
    - name: 安装 Rust 工具链
      uses: dtolnay/rust-toolchain@stable
      with: { targets: "${{ matrix.target }}" }
    - name: 安装系统依赖 (Ubuntu)
      if: matrix.os == 'ubuntu-24.04'
      run: |
        sudo apt-get update
        sudo apt-get install -y libwebkit2gtk-4.1-dev libjavascriptcoregtk-4.1-dev libgtk-3-dev libayatana-appindicator3-dev librsvg2-dev build-essential
    - name: Rust 缓存
      uses: Swatinem/rust-cache@v2
      with: { workspaces: './src-tauri -> target', key: "${{ matrix.target }}" }
    - name: 构建裸二进制文件
      shell: bash
      run: |
        cd src-tauri
        cargo build --release --target ${{ matrix.target }} --verbose
    - name: 准备并重命名二进制文件
      shell: bash
      run: |
        mkdir -p ./artifact
        APP_NAME="sidecar" # 确保这是你 Cargo.toml 中的 [package].name
        SOURCE_DIR="src-tauri/target/${{ matrix.target }}/release"
        TARGET_NAME="sidecar-${{ matrix.name }}"
        if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
          cp "${SOURCE_DIR}/${APP_NAME}.exe" "./artifact/${TARGET_NAME}.exe"
        else
          cp "${SOURCE_DIR}/${APP_NAME}" "./artifact/${TARGET_NAME}"
          chmod +x "./artifact/${TARGET_NAME}"
        fi
        ls -l ./artifact
    - name: 上传单个平台的二进制文件
      uses: actions/upload-artifact@v4
      with: { name: "sidecar-binary-${{ matrix.name }}", path: ./artifact/, retention-days: 7 }

  # ===================================================================
  # 步骤 2: (已修正) 合并二进制文件并准备发布包
  # ===================================================================
  merge_and_release:
    needs: build
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码 (用于获取 README)
      uses: actions/checkout@v4

    - name: 下载所有构建好的二进制文件
      uses: actions/download-artifact@v4
      with: { path: all-binaries/ } # 只指定根目录

    - name: 整理文件并创建发布包
      id: prep_release
      run: |
        # 1. 创建一个用于存放【零散文件】的干净目录
        mkdir -p release_files
        
        # 2. ✅ 【核心修正】使用 find 命令，忽略目录层级，直接将所有二进制文件移动到准备区
        find ./all-binaries -type f -exec mv {} ./release_files/ \;
        
        # 3. 在【零散文件】目录内生成校验和
        cd release_files
        sha256sum sidecar-* > checksums.txt
        cd ..
        
        # 4. 创建一个用于存放【最终成品】的目录
        mkdir -p final_package
        
        # 5. 将【零散文件】目录里的所有东西，都移动到【最终成品】目录
        mv release_files/* final_package/
        
        # 6. 创建包含所有零散文件的压缩包，并直接放在【最终成品】目录里
        VERSION="${GITHUB_REF_NAME:-latest}"
        CLEAN_VERSION=$(echo "$VERSION" | sed 's/^v//')
        tar -czf "final_package/sidecar-${CLEAN_VERSION}-all-platforms.tar.gz" -C final_package .
        
        # 7. 将 README 也复制到【最终成品】目录
        if [ -f "README-BINARY.md" ]; then
          cp README-BINARY.md final_package/
        fi
        
        echo "✅ Final release package prepared:"
        ls -lR final_package/

    - name: 上传最终的发布包 (作为构建产物)
      uses: actions/upload-artifact@v4
      with:
        name: sidecar-release-package
        path: final_package/ # 只上传这个包含所有成品的目录
        retention-days: 30

    - name: 创建 GitHub Release (仅在打标签时触发)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        # 关键改动: 只上传干净的【最终成品】目录里的所有文件
        files: final_package/*
        body: |
          ## 🎉 Sidecar ${{ github.ref_name }} Release
          
          This release contains the bare-metal binaries for Sidecar. 
          Download the appropriate binary for your system, or the `.tar.gz` archive containing all platforms.
          
          ### ✅ Verification
          
          Please verify the integrity of the downloaded files using the `checksums.txt`:
          ```bash
          sha256sum -c checksums.txt
          ```

          ### 🚀 Quick Start
          
          **Linux / macOS:**
          ```bash
          chmod +x ./sidecar-linux-x64
          ./sidecar-linux-x64 --url https://example.com
          ```
          
          **Windows (CMD/PowerShell):**
          ```cmd
          sidecar-windows-x64.exe --url https://example.com
          ```
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
