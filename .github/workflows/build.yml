name: 构建二进制文件

on:
  push:
    branches: [ main, master, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
            name: linux-x64
            
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            name: windows-x64
            
          - os: macos-latest
            target: x86_64-apple-darwin
            name: macos-intel
            
          - os: macos-latest
            target: aarch64-apple-darwin
            name: macos-arm64

    runs-on: ${{ matrix.os }}

    steps:
    - name: 检出代码
      uses: actions/checkout@v4

    - name: 安装 Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.target }}

    # Ubuntu 依赖 - 修复 JavaScriptCore 问题
    - name: 安装系统依赖 (Ubuntu)
      if: matrix.os == 'ubuntu-22.04'
      run: |
        sudo apt-get update
        # 安装所有必要的依赖，包括 JavaScriptCore
        sudo apt-get install -y \
          libwebkit2gtk-4.0-dev \
          libjavascriptcoregtk-4.0-dev \
          libgtk-3-dev \
          libayatana-appindicator3-dev \
          librsvg2-dev \
          patchelf \
          pkg-config \
          libssl-dev
        
        # 验证 pkg-config 能找到依赖
        echo "=== 验证依赖 ==="
        pkg-config --modversion webkit2gtk-4.0 || echo "webkit2gtk-4.0 未找到"
        pkg-config --modversion javascriptcoregtk-4.0 || echo "javascriptcoregtk-4.0 未找到"

    - name: Rust 缓存
      uses: Swatinem/rust-cache@v2
      with:
        workspaces: './src-tauri -> target'
        key: ${{ matrix.target }}

    # 修复：使用跨平台的准备步骤
    - name: 准备构建环境 (Unix)
      if: matrix.os != 'windows-latest'
      shell: bash
      run: |
        mkdir -p empty_dist
        echo "<!DOCTYPE html><html><body></body></html>" > empty_dist/index.html

    - name: 准备构建环境 (Windows)
      if: matrix.os == 'windows-latest'
      shell: pwsh
      run: |
        # PowerShell 版本
        if (-not (Test-Path "empty_dist")) {
          New-Item -ItemType Directory -Path "empty_dist" -Force
        }
        '<!DOCTYPE html><html><body></body></html>' | Out-File -FilePath "empty_dist\index.html" -Encoding UTF8

    # 构建步骤 - 为 Ubuntu 设置额外环境变量
    - name: 构建 (Unix)
      if: matrix.os != 'windows-latest'
      shell: bash
      run: |
        cd src-tauri
        
        # Ubuntu 特殊环境变量
        if [ "${{ matrix.os }}" = "ubuntu-22.04" ]; then
          export WEBKIT_DISABLE_COMPOSITING_MODE=1
          export PKG_CONFIG_PATH="/usr/lib/x86_64-linux-gnu/pkgconfig:/usr/share/pkgconfig:$PKG_CONFIG_PATH"
        fi
        
        cargo build --release --target ${{ matrix.target }}

    - name: 构建 (Windows)
      if: matrix.os == 'windows-latest'
      shell: pwsh
      run: |
        cd src-tauri
        cargo build --release --target ${{ matrix.target }}

    # 收集二进制文件
    - name: 准备上传 (Unix)
      if: matrix.os != 'windows-latest'
      shell: bash
      run: |
        BINARY_PATH="src-tauri/target/${{ matrix.target }}/release/gui"
        
        if [ -f "$BINARY_PATH" ]; then
          cp "$BINARY_PATH" "gui-${{ matrix.name }}"
          chmod +x "gui-${{ matrix.name }}"
          echo "✅ 二进制文件准备完成: gui-${{ matrix.name }}"
          ls -lh "gui-${{ matrix.name }}"
        else
          echo "❌ 未找到二进制文件: $BINARY_PATH"
          exit 1
        fi

    - name: 准备上传 (Windows)
      if: matrix.os == 'windows-latest'
      shell: pwsh
      run: |
        $binaryPath = "src-tauri\target\${{ matrix.target }}\release\gui.exe"
        
        if (Test-Path $binaryPath) {
          Copy-Item $binaryPath "gui-${{ matrix.name }}.exe"
          Write-Host "✅ 二进制文件准备完成: gui-${{ matrix.name }}.exe"
          Get-Item "gui-${{ matrix.name }}.exe" | Select-Object Name, Length
        } else {
          Write-Error "❌ 未找到二进制文件: $binaryPath"
          exit 1
        }

    # 上传
    - name: 上传二进制文件
      uses: actions/upload-artifact@v4
      with:
        name: gui-${{ matrix.name }}
        path: gui-${{ matrix.name }}*
        retention-days: 30

  # 合并任务保持不变
  merge:
    needs: build
    runs-on: ubuntu-latest
    
    steps:
    - name: 下载所有二进制文件
      uses: actions/download-artifact@v4
      with:
        path: binaries
        pattern: gui-*
        merge-multiple: true

    - name: 显示所有文件
      run: |
        echo "=== 所有二进制文件 ==="
        ls -lh binaries/
        
        echo -e "\n=== SHA256 校验和 ==="
        cd binaries
        sha256sum gui-* || true

    - name: 创建统一压缩包
      run: |
        cd binaries
        tar -czf ../gui-all-platforms.tar.gz gui-*
        cd ..
        ls -lh gui-all-platforms.tar.gz

    - name: 上传合并包
      uses: actions/upload-artifact@v4
      with:
        name: gui-all-platforms
        path: |
          binaries/gui-*
          gui-all-platforms.tar.gz
        retention-days: 30

    - name: 创建 Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          binaries/gui-*
          gui-all-platforms.tar.gz
        body: |
          ## 下载说明
          
          ### 单独下载
          - **Windows (64位)**: `gui-windows-x64.exe`
          - **macOS (Intel)**: `gui-macos-intel`
          - **macOS (Apple Silicon)**: `gui-macos-arm64`
          - **Linux (64位)**: `gui-linux-x64`
          
          ### 使用方法
          1. 下载对应平台的文件
          2. 添加执行权限（Unix/macOS）: `chmod +x gui-*`
          3. 运行: `./gui-* --url https://your-url.com`
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
