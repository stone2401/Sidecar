name: æž„å»ºäºŒè¿›åˆ¶æ–‡ä»¶

on:
  push:
    branches: [ main, master, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          # ä½¿ç”¨ Ubuntu 24.04 ä»¥èŽ·å¾— webkit2gtk-4.1 æ”¯æŒ
          - os: ubuntu-24.04
            target: x86_64-unknown-linux-gnu
            name: linux-x64
            
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            name: windows-x64
            
          - os: macos-latest
            target: x86_64-apple-darwin
            name: macos-intel
            
          - os: macos-latest
            target: aarch64-apple-darwin
            name: macos-arm64

    runs-on: ${{ matrix.os }}

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: å®‰è£… Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.target }}

    # Ubuntu 24.04 ä¾èµ–
    - name: å®‰è£…ç³»ç»Ÿä¾èµ– (Ubuntu 24.04)
      if: matrix.os == 'ubuntu-24.04'
      run: |
        echo "=== ç³»ç»Ÿä¿¡æ¯ ==="
        lsb_release -a
        
        echo "=== æ›´æ–°åŒ…åˆ—è¡¨ ==="
        sudo apt-get update
        
        echo "=== å®‰è£… Tauri ä¾èµ– ==="
        sudo apt-get install -y \
          libwebkit2gtk-4.1-dev \
          libjavascriptcoregtk-4.1-dev \
          libgtk-3-dev \
          libayatana-appindicator3-dev \
          librsvg2-dev \
          patchelf \
          pkg-config \
          libssl-dev \
          build-essential \
          curl \
          wget \
          file
        
        echo "=== éªŒè¯ä¾èµ–å®‰è£… ==="
        pkg-config --modversion webkit2gtk-4.1 || echo "webkit2gtk-4.1 æœªæ‰¾åˆ°"
        pkg-config --modversion javascriptcoregtk-4.1 || echo "javascriptcoregtk-4.1 æœªæ‰¾åˆ°"
        pkg-config --modversion gtk+-3.0 || echo "gtk+-3.0 æœªæ‰¾åˆ°"
        
        echo "=== æ˜¾ç¤ºæ‰€æœ‰ webkit ç›¸å…³åŒ… ==="
        pkg-config --list-all | grep -i webkit || true

    - name: Rust ç¼“å­˜
      uses: Swatinem/rust-cache@v2
      with:
        workspaces: './src-tauri -> target'
        key: ${{ matrix.target }}

    # å‡†å¤‡æž„å»ºçŽ¯å¢ƒ - Unix
    - name: å‡†å¤‡æž„å»ºçŽ¯å¢ƒ (Unix)
      if: matrix.os != 'windows-latest'
      shell: bash
      run: |
        mkdir -p empty_dist
        echo "<!DOCTYPE html><html><body></body></html>" > empty_dist/index.html
        
        echo "=== é¡¹ç›®ç»“æž„ ==="
        ls -la
        if [ -d "src-tauri" ]; then
          echo "=== src-tauri å†…å®¹ ==="
          ls -la src-tauri/
        fi

    # å‡†å¤‡æž„å»ºçŽ¯å¢ƒ - Windows
    - name: å‡†å¤‡æž„å»ºçŽ¯å¢ƒ (Windows)
      if: matrix.os == 'windows-latest'
      shell: pwsh
      run: |
        if (-not (Test-Path "empty_dist")) {
          New-Item -ItemType Directory -Path "empty_dist" -Force
        }
        '<!DOCTYPE html><html><body></body></html>' | Out-File -FilePath "empty_dist\index.html" -Encoding UTF8
        
        Write-Host "=== é¡¹ç›®ç»“æž„ ==="
        Get-ChildItem -Force
        if (Test-Path "src-tauri") {
          Write-Host "=== src-tauri å†…å®¹ ==="
          Get-ChildItem "src-tauri" -Force
        }

    # æž„å»º - Unix
    - name: æž„å»º (Unix)
      if: matrix.os != 'windows-latest'
      shell: bash
      run: |
        cd src-tauri
        
        # Ubuntu ç‰¹æ®ŠçŽ¯å¢ƒå˜é‡
        if [[ "${{ matrix.os }}" == "ubuntu-24.04" ]]; then
          export WEBKIT_DISABLE_COMPOSITING_MODE=1
          export PKG_CONFIG_PATH="/usr/lib/x86_64-linux-gnu/pkgconfig:/usr/share/pkgconfig:$PKG_CONFIG_PATH"
          echo "PKG_CONFIG_PATH=$PKG_CONFIG_PATH"
        fi
        
        echo "=== å¼€å§‹æž„å»º ${{ matrix.target }} ==="
        cargo build --release --target ${{ matrix.target }} --verbose
        
        echo "=== æž„å»ºå®Œæˆï¼Œæ£€æŸ¥è¾“å‡º ==="
        ls -la target/${{ matrix.target }}/release/

    # æž„å»º - Windows
    - name: æž„å»º (Windows)
      if: matrix.os == 'windows-latest'
      shell: pwsh
      run: |
        cd src-tauri
        
        Write-Host "=== å¼€å§‹æž„å»º ${{ matrix.target }} ==="
        cargo build --release --target ${{ matrix.target }} --verbose
        
        Write-Host "=== æž„å»ºå®Œæˆï¼Œæ£€æŸ¥è¾“å‡º ==="
        Get-ChildItem "target\${{ matrix.target }}\release\"

    # æ”¶é›†äºŒè¿›åˆ¶æ–‡ä»¶ - Unix
    - name: å‡†å¤‡ä¸Šä¼  (Unix)
      if: matrix.os != 'windows-latest'
      shell: bash
      run: |
        BINARY_PATH="src-tauri/target/${{ matrix.target }}/release/gui"
        
        if [ -f "$BINARY_PATH" ]; then
          cp "$BINARY_PATH" "gui-${{ matrix.name }}"
          chmod +x "gui-${{ matrix.name }}"
          
          # èŽ·å–æ–‡ä»¶ä¿¡æ¯
          echo "âœ… äºŒè¿›åˆ¶æ–‡ä»¶å‡†å¤‡å®Œæˆ"
          ls -lh "gui-${{ matrix.name }}"
          file "gui-${{ matrix.name }}"
          
          # Linux ç‰¹å®šï¼šæ˜¾ç¤ºä¾èµ–ä¿¡æ¯
          if [[ "${{ matrix.os }}" == "ubuntu-24.04" ]]; then
            echo "=== åŠ¨æ€åº“ä¾èµ– ==="
            ldd "gui-${{ matrix.name }}" || true
          fi
        else
          echo "âŒ æœªæ‰¾åˆ°äºŒè¿›åˆ¶æ–‡ä»¶: $BINARY_PATH"
          echo "target ç›®å½•å†…å®¹ï¼š"
          find src-tauri/target -type f -name "gui*" || true
          exit 1
        fi

    # æ”¶é›†äºŒè¿›åˆ¶æ–‡ä»¶ - Windows
    - name: å‡†å¤‡ä¸Šä¼  (Windows)
      if: matrix.os == 'windows-latest'
      shell: pwsh
      run: |
        $binaryPath = "src-tauri\target\${{ matrix.target }}\release\gui.exe"
        
        if (Test-Path $binaryPath) {
          Copy-Item $binaryPath "gui-${{ matrix.name }}.exe"
          
          Write-Host "âœ… äºŒè¿›åˆ¶æ–‡ä»¶å‡†å¤‡å®Œæˆ"
          Get-Item "gui-${{ matrix.name }}.exe" | Select-Object Name, Length, LastWriteTime
          
          # æ£€æŸ¥æ˜¯å¦æœ‰ DLL ä¾èµ–
          $dllPath = Split-Path $binaryPath -Parent
          $dlls = Get-ChildItem "$dllPath\*.dll" -ErrorAction SilentlyContinue
          if ($dlls) {
            Write-Host "=== DLL ä¾èµ– ==="
            $dlls | ForEach-Object { Write-Host $_.Name }
          }
        } else {
          Write-Error "âŒ æœªæ‰¾åˆ°äºŒè¿›åˆ¶æ–‡ä»¶: $binaryPath"
          Write-Host "target ç›®å½•å†…å®¹ï¼š"
          Get-ChildItem "src-tauri\target" -Recurse -Filter "gui*"
          exit 1
        }

    # ä¸Šä¼ å•ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶
    - name: ä¸Šä¼ äºŒè¿›åˆ¶æ–‡ä»¶
      uses: actions/upload-artifact@v4
      with:
        name: gui-${{ matrix.name }}
        path: gui-${{ matrix.name }}*
        retention-days: 30

  # åˆå¹¶æ‰€æœ‰äºŒè¿›åˆ¶æ–‡ä»¶
  merge:
    needs: build
    runs-on: ubuntu-latest
    
    steps:
    - name: ä¸‹è½½æ‰€æœ‰äºŒè¿›åˆ¶æ–‡ä»¶
      uses: actions/download-artifact@v4
      with:
        path: binaries
        pattern: gui-*
        merge-multiple: true

    - name: æ˜¾ç¤ºæ‰€æœ‰æ–‡ä»¶
      run: |
        echo "=== æ‰€æœ‰äºŒè¿›åˆ¶æ–‡ä»¶ ==="
        ls -lah binaries/
        
        echo -e "\n=== æ–‡ä»¶ç±»åž‹ä¿¡æ¯ ==="
        file binaries/gui-* || true
        
        echo -e "\n=== SHA256 æ ¡éªŒå’Œ ==="
        cd binaries
        sha256sum gui-* | tee checksums.txt

    - name: åˆ›å»ºå‘å¸ƒåŒ…
      run: |
        cd binaries
        
        # åˆ›å»ºå¸¦ç‰ˆæœ¬å·çš„åŽ‹ç¼©åŒ…
        VERSION="${GITHUB_REF_NAME:-latest}"
        tar -czf "../gui-${VERSION}-all-platforms.tar.gz" gui-* checksums.txt
        
        # åˆ›å»º README
        cat > ../README-BINARY.md << 'EOF'
        # GUI äºŒè¿›åˆ¶æ–‡ä»¶
        
        ## æ–‡ä»¶è¯´æ˜Ž
        - `gui-linux-x64` - Linux x64 äºŒè¿›åˆ¶æ–‡ä»¶
        - `gui-windows-x64.exe` - Windows x64 å¯æ‰§è¡Œæ–‡ä»¶
        - `gui-macos-intel` - macOS Intel äºŒè¿›åˆ¶æ–‡ä»¶
        - `gui-macos-arm64` - macOS Apple Silicon äºŒè¿›åˆ¶æ–‡ä»¶
        - `checksums.txt` - SHA256 æ ¡éªŒå’Œ
        
        ## ä½¿ç”¨æ–¹æ³•
        
        ### Linux/macOS
        ```bash
        chmod +x gui-*
        ./gui-linux-x64 --url https://example.com
        ```
        
        ### Windows
        ```cmd
        gui-windows-x64.exe --url https://example.com
        ```
        
        ## ä¾èµ–è¯´æ˜Ž
        - Linux: éœ€è¦ GTK3 å’Œ WebKitGTK
        - Windows: éœ€è¦ WebView2 Runtime
        - macOS: æ— é¢å¤–ä¾èµ–
        EOF
        
        cd ..
        ls -lah gui-*.tar.gz README-BINARY.md

    - name: ä¸Šä¼ åˆå¹¶åŒ…
      uses: actions/upload-artifact@v4
      with:
        name: gui-all-platforms
        path: |
          binaries/gui-*
          gui-*.tar.gz
          README-BINARY.md
        retention-days: 30

    # åˆ›å»º Releaseï¼ˆä»…åœ¨æ‰“æ ‡ç­¾æ—¶ï¼‰
    - name: åˆ›å»º Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          binaries/gui-*
          gui-*.tar.gz
          binaries/checksums.txt
        body: |
          ## ðŸŽ‰ GUI ${{ github.ref_name }} å‘å¸ƒ
          
          ### ðŸ“¦ ä¸‹è½½æ–‡ä»¶
          
          #### å•ç‹¬å¹³å°æ–‡ä»¶
          - **Linux x64**: `gui-linux-x64`
          - **Windows x64**: `gui-windows-x64.exe`
          - **macOS Intel**: `gui-macos-intel`
          - **macOS Apple Silicon**: `gui-macos-arm64`
          
          #### å…¨å¹³å°æ‰“åŒ…
          - `gui-${{ github.ref_name }}-all-platforms.tar.gz` - åŒ…å«æ‰€æœ‰å¹³å°äºŒè¿›åˆ¶æ–‡ä»¶
          
          ### ðŸš€ å¿«é€Ÿå¼€å§‹
          
          1. ä¸‹è½½å¯¹åº”å¹³å°çš„æ–‡ä»¶
          2. æ·»åŠ æ‰§è¡Œæƒé™ï¼ˆUnix/macOSï¼‰ï¼š
             ```bash
             chmod +x gui-*
             ```
          3. è¿è¡Œåº”ç”¨ï¼š
             ```bash
             # ä½¿ç”¨é»˜è®¤ URL
             ./gui-linux-x64
             
             # æŒ‡å®šè‡ªå®šä¹‰ URL
             ./gui-linux-x64 --url https://your-app.com
             ```
          
          ### âœ… æ–‡ä»¶æ ¡éªŒ
          
          è¯·ä½¿ç”¨ `checksums.txt` éªŒè¯ä¸‹è½½æ–‡ä»¶çš„å®Œæ•´æ€§ï¼š
          ```bash
          sha256sum -c checksums.txt
          ```
          
          ### ðŸ“‹ ç³»ç»Ÿè¦æ±‚
          
          - **Linux**: Ubuntu 20.04+ æˆ–å…¶ä»–æ”¯æŒ GTK3 çš„å‘è¡Œç‰ˆ
          - **Windows**: Windows 10 1809+ (éœ€è¦ WebView2 Runtime)
          - **macOS**: macOS 10.13+
          
          ### ðŸ› é—®é¢˜åé¦ˆ
          
          å¦‚æœ‰é—®é¢˜è¯·åœ¨ [Issues](https://github.com/${{ github.repository }}/issues) ä¸­åé¦ˆã€‚
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
